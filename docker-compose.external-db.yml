# ============================================
# OpenChat Server - Docker Compose 配置
# 使用外部数据库和 Redis
# 支持自定义数据库、Redis 和 WukongIM 连接配置
# ============================================

version: '3.8'

services:
  # ============================================
  # OpenChat 应用 (仅启动应用，使用外部服务)
  # ============================================
  app:
    image: ${DOCKER_REGISTRY:-}openchat/server:${APP_VERSION:-latest}
    container_name: openchat
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      # 环境配置
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${APP_PORT:-3000}
      HOST: 0.0.0.0
      
      # 数据库配置 - 外部 PostgreSQL
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-openchat}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME:-openchat}
      DB_SYNCHRONIZE: ${DB_SYNCHRONIZE:-false}
      DB_LOGGING: ${DB_LOGGING:-false}
      # 连接池配置
      DB_POOL_MAX: ${DB_POOL_MAX:-20}
      DB_POOL_MIN: ${DB_POOL_MIN:-5}
      DB_IDLE_TIMEOUT: ${DB_IDLE_TIMEOUT:-30000}
      DB_CONNECTION_TIMEOUT: ${DB_CONNECTION_TIMEOUT:-5000}
      DB_MAX_LIFETIME: ${DB_MAX_LIFETIME:-300000}
      
      # Redis 配置 - 外部 Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_QUEUE_DB: ${REDIS_QUEUE_DB:-1}
      # Redis 连接池配置
      REDIS_CONNECT_TIMEOUT: ${REDIS_CONNECT_TIMEOUT:-10000}
      REDIS_MAX_RETRIES: ${REDIS_MAX_RETRIES:-3}
      
      # JWT 配置
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-30d}
      
      # 悟空IM 配置 - 外部或内部
      WUKONGIM_API_URL: ${WUKONGIM_API_URL:-http://wukongim:5001}
      WUKONGIM_TCP_ADDR: ${WUKONGIM_TCP_ADDR:-wukongim:5100}
      WUKONGIM_WS_URL: ${WUKONGIM_WS_URL:-ws://wukongim:5200}
      WUKONGIM_MANAGER_URL: ${WUKONGIM_MANAGER_URL:-http://wukongim:5300}
      WUKONGIM_TOKEN_AUTH: ${WUKONGIM_TOKEN_AUTH:-false}
      WUKONGIM_TIMEOUT: ${WUKONGIM_TIMEOUT:-10000}
      WUKONGIM_APP_ID: ${WUKONGIM_APP_ID:-}
      WUKONGIM_APP_SECRET: ${WUKONGIM_APP_SECRET:-}
      
      # 安全配置
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL:-60}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      BCRYPT_SALT_ROUNDS: ${BCRYPT_SALT_ROUNDS:-10}
      
      # 日志配置
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      LOG_FILE_ENABLED: ${LOG_FILE_ENABLED:-false}
      
      # 队列配置
      QUEUE_ENABLED: ${QUEUE_ENABLED:-true}
      
      # 性能配置
      SLOW_QUERY_THRESHOLD: ${SLOW_QUERY_THRESHOLD:-1000}
      DB_QUERY_TIMEOUT: ${DB_QUERY_TIMEOUT:-30000}
      BATCH_SIZE: ${BATCH_SIZE:-100}
      CONCURRENCY_MAX: ${CONCURRENCY_MAX:-10}
      
      # 缓存配置
      CACHE_WARMUP_ON_START: ${CACHE_WARMUP_ON_START:-false}
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-300}
      CACHE_NULL_TTL: ${CACHE_NULL_TTL:-60}
      
      # 外部 IP 配置
      EXTERNAL_IP: ${EXTERNAL_IP:-}
      INTERNAL_IP: ${INTERNAL_IP:-}
    volumes:
      - app_logs:/app/var/logs
      - app_data:/app/var/data
    ports:
      - "${APP_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - openchat-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: ${APP_MEMORY_LIMIT:-1G}
        reservations:
          memory: ${APP_MEMORY_RESERVE:-512M}
      replicas: ${APP_REPLICAS:-1}

  # ============================================
  # 悟空IM 服务 (可选，使用外部IM则可禁用)
  # ============================================
  wukongim:
    image: ${WUKONGIM_IMAGE:-registry.cn-shanghai.aliyuncs.com/wukongim/wukongim:v2}
    container_name: openchat-wukongim
    restart: ${RESTART_POLICY:-unless-stopped}
    profiles:
      - wukongim
    environment:
      # 集群配置
      - "WK_CLUSTER_NODEID=${WK_CLUSTER_NODEID:-1001}"
      - "WK_MODE=${WK_MODE:-release}"
      - "WK_EXTERNAL_IP=${EXTERNAL_IP}"
      - "WK_CLUSTER_SERVERADDR=${WK_CLUSTER_SERVERADDR:-wukongim:11110}"
      - "WK_CLUSTER_APIURL=http://wukongim:5001"
      - "WK_TOKENAUTHON=${WUKONGIM_TOKEN_AUTH:-false}"
      
      # 端口配置
      - "WK_HTTP_PORT=5001"
      - "WK_TCP_PORT=5100"
      - "WK_WS_PORT=5200"
      - "WK_MANAGER_PORT=5300"
      - "WK_CLUSTER_PORT=11110"
      
      # 数据配置
      - "WK_DATA_DIR=/root/wukongim"
      - "WK_NODEID=${WK_CLUSTER_NODEID:-1001}"
      
      # 性能配置
      - "WK_CONN_MAX=${WK_CONN_MAX:-10000}"
      - "WK_CHANNEL_MAX=${WK_CHANNEL_MAX:-1000}"
      - "WK_MAX_CHANNELS_PER_USER=${WK_MAX_CHANNELS_PER_USER:-100}"
      
      # 日志配置
      - "WK_LOG_LEVEL=${WK_LOG_LEVEL:-info}"
      - "WK_LOG_MAX_SIZE=${WK_LOG_MAX_SIZE:-100}"
      - "WK_LOG_MAX_FILES=${WK_LOG_MAX_FILES:-7}"
      
      # 消息配置
      - "WK_MSG_MAX_SIZE=${WK_MSG_MAX_SIZE:-4096}"
      - "WK_MSG_CACHE_SIZE=${WK_MSG_CACHE_SIZE:-1000}"
      - "WK_MSG_GC_INTERVAL=${WK_MSG_GC_INTERVAL:-300}"
      
      # 存储配置
      - "WK_STORE_TYPE=${WK_STORE_TYPE:-sqlite}"
      - "WK_STORE_PATH=/root/wukongim/data"
      
      # Redis 配置（用于分布式）
      - "WK_REDIS_HOST=${WK_REDIS_HOST:-}"
      - "WK_REDIS_PORT=${WK_REDIS_PORT:-6379}"
      - "WK_REDIS_PASSWORD=${WK_REDIS_PASSWORD:-}"
      - "WK_REDIS_DB=${WK_REDIS_DB:-0}"
      
      # Token 配置
      - "WK_TOKEN_SECRET=${WK_TOKEN_SECRET:-}"
      - "WK_TOKEN_EXPIRE=${WK_TOKEN_EXPIRE:-86400}"
      
      # Webhook 配置
      - "WK_WEBHOOK_ENABLED=${WK_WEBHOOK_ENABLED:-false}"
      - "WK_WEBHOOK_URL=${WK_WEBHOOK_URL:-}"
      - "WK_WEBHOOK_TIMEOUT=${WK_WEBHOOK_TIMEOUT:-5000}"
      
      # 限流配置
      - "WK_RATE_LIMIT_ENABLED=${WK_RATE_LIMIT_ENABLED:-true}"
      - "WK_RATE_LIMIT_MAX=${WK_RATE_LIMIT_MAX:-100}"
      - "WK_RATE_LIMIT_WINDOW=${WK_RATE_LIMIT_WINDOW:-60}"
    healthcheck:
      test: "wget -q -Y off -O /dev/null http://localhost:5001/health > /dev/null 2>&1"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - wukongim_data:/root/wukongim
    ports:
      - "${WUKONGIM_API_PORT:-5001}:5001"
      - "${WUKONGIM_TCP_PORT:-5100}:5100"
      - "${WUKONGIM_WS_PORT:-5200}:5200"
      - "${WUKONGIM_MANAGER_PORT:-5300}:5300"
      - "${WUKONGIM_CLUSTER_PORT:-11110}:11110"
    networks:
      - openchat-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: ${WUKONGIM_MEMORY_LIMIT:-1G}
        reservations:
          memory: ${WUKONGIM_MEMORY_RESERVE:-512M}

  # ============================================
  # Prometheus 监控 (可选)
  # ============================================
  prometheus:
    image: prom/prometheus:${PROMETHEUS_VERSION:-v2.48.0}
    container_name: openchat-prometheus
    restart: ${RESTART_POLICY:-unless-stopped}
    profiles:
      - monitoring
    volumes:
      - ./etc/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - openchat-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  app_logs:
    driver: local
  app_data:
    driver: local
  wukongim_data:
    driver: local
  prometheus_data:
    driver: local

networks:
  openchat-network:
    driver: bridge
    name: ${NETWORK_NAME:-openchat-network}
